<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Clawdbot</title>
    
    <script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIGURATION â€” Customize your webchat here
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.CLAWDBOT_WEBCHAT_CONFIG = {
    // Bot identity
    name: 'Clawdbot',           // Display name in header
    emoji: 'ğŸ¤–',                // Emoji/icon next to name
    
    // Session
    sessionKey: 'main',          // Gateway session key
    
    // File uploads
    maxFileSize: 5 * 1024 * 1024, // 5MB default (gateway limit)
    allowedFileTypes: 'image/*,video/*,audio/*,.gif,.pdf,.doc,.docx,.txt,.csv,.json,.xml,.zip',
    
    // Appearance
    defaultTheme: 'default',     // default, matrix, god, futuristic, ascii, ocean
    
    // Language (en or tr)
    locale: 'en',
    
    // Custom strings (override any locale string)
    strings: {}
};
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-primary: #08080d;
            --bg-secondary: #0f0f15;
            --bg-avatar: #0a0a12;
            --accent-1: #8b5cf6;
            --accent-2: #06b6d4;
            --text-primary: #e0e0e0;
            --text-secondary: rgba(224, 224, 224, 0.6);
            --border-color: rgba(139, 92, 246, 0.2);
            --user-bubble: linear-gradient(135deg, #8b5cf6, #7c3aed);
            --assistant-bubble-bg: rgba(6, 182, 212, 0.1);
            --assistant-bubble-border: rgba(6, 182, 212, 0.3);
            --glow-color: rgba(139, 92, 246, 0.4);
            --particle-color: #8b5cf6;
            --font-main: 'Outfit', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        [data-theme="matrix"] {
            --bg-primary: #000a00; --bg-secondary: #001200; --bg-avatar: #000800;
            --accent-1: #00ff41; --accent-2: #00cc33;
            --text-primary: #00ff41; --text-secondary: rgba(0,255,65,0.5);
            --border-color: rgba(0,255,65,0.2);
            --user-bubble: linear-gradient(135deg, #00cc33, #009926);
            --assistant-bubble-bg: rgba(0,255,65,0.08);
            --assistant-bubble-border: rgba(0,255,65,0.3);
            --glow-color: rgba(0,255,65,0.4); --particle-color: #00ff41;
            --font-main: 'JetBrains Mono', monospace;
        }

        [data-theme="god"] {
            --bg-primary: #0a0510; --bg-secondary: #100818; --bg-avatar: #08030d;
            --accent-1: #ffd700; --accent-2: #ff6b00;
            --text-primary: #fff5db; --text-secondary: rgba(255,245,219,0.5);
            --border-color: rgba(255,215,0,0.25);
            --user-bubble: linear-gradient(135deg, #ffd700, #ff8c00);
            --assistant-bubble-bg: rgba(255,215,0,0.08);
            --assistant-bubble-border: rgba(255,215,0,0.3);
            --glow-color: rgba(255,215,0,0.5); --particle-color: #ffd700;
        }

        [data-theme="futuristic"] {
            --bg-primary: #05000d; --bg-secondary: #0a0015; --bg-avatar: #07000f;
            --accent-1: #ff00ff; --accent-2: #00ffff;
            --text-primary: #f0e0ff; --text-secondary: rgba(240,224,255,0.5);
            --border-color: rgba(255,0,255,0.25);
            --user-bubble: linear-gradient(135deg, #ff00ff, #cc00cc);
            --assistant-bubble-bg: rgba(0,255,255,0.08);
            --assistant-bubble-border: rgba(0,255,255,0.3);
            --glow-color: rgba(255,0,255,0.5); --particle-color: #ff00ff;
        }

        [data-theme="ascii"] {
            --bg-primary: #1a1a2e; --bg-secondary: #16213e; --bg-avatar: #0f1a30;
            --accent-1: #e94560; --accent-2: #0f3460;
            --text-primary: #eee; --text-secondary: rgba(238,238,238,0.5);
            --border-color: rgba(233,69,96,0.3);
            --user-bubble: linear-gradient(135deg, #e94560, #c73a52);
            --assistant-bubble-bg: rgba(15,52,96,0.3);
            --assistant-bubble-border: rgba(233,69,96,0.3);
            --glow-color: rgba(233,69,96,0.4); --particle-color: #e94560;
            --font-main: 'JetBrains Mono', monospace;
        }

        [data-theme="ocean"] {
            --bg-primary: #020c1b; --bg-secondary: #0a192f; --bg-avatar: #061222;
            --accent-1: #64ffda; --accent-2: #5cc9f5;
            --text-primary: #ccd6f6; --text-secondary: rgba(136,146,176,0.8);
            --border-color: rgba(100,255,218,0.2);
            --user-bubble: linear-gradient(135deg, #64ffda, #4ac9b0);
            --assistant-bubble-bg: rgba(100,255,218,0.06);
            --assistant-bubble-border: rgba(100,255,218,0.2);
            --glow-color: rgba(100,255,218,0.3); --particle-color: #64ffda;
        }

        body {
            font-family: var(--font-main);
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh; height: 100dvh;
            overflow: hidden;
        }

        .container { display: flex; height: 100vh; height: 100dvh; max-width: 1600px; margin: 0 auto; }

        /* â”€â”€ Avatar Section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .avatar-section {
            flex: 0 0 35%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 2rem;
            background: linear-gradient(135deg, var(--bg-avatar) 0%, var(--bg-secondary) 100%);
            position: relative; overflow: hidden;
        }
        .avatar-section::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, color-mix(in srgb, var(--accent-1) 5%, transparent) 0%, transparent 70%);
            animation: pulse 8s ease-in-out infinite;
        }
        @keyframes pulse { 0%,100%{transform:scale(1);opacity:.3} 50%{transform:scale(1.1);opacity:.5} }

        .bg-particles { position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;overflow:hidden; }
        .bg-particle {
            position:absolute; width:3px; height:3px; background:var(--accent-1); border-radius:50%; opacity:0;
            animation: floatP var(--dur,8s) var(--delay,0s) infinite ease-in-out;
        }
        @keyframes floatP { 0%{opacity:0;transform:translateY(100vh) scale(0)} 10%{opacity:.6} 90%{opacity:.6} 100%{opacity:0;transform:translateY(-20vh) scale(1.5)} }

        .matrix-rain { display:none;position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;overflow:hidden;z-index:0; }
        [data-theme="matrix"] .matrix-rain { display:block; }
        .matrix-column {
            position:absolute;top:-100%;font-family:'JetBrains Mono',monospace;font-size:14px;color:#00ff41;
            writing-mode:vertical-rl;animation:matrixFall var(--speed,8s) linear infinite;opacity:.3;
        }
        @keyframes matrixFall { 0%{transform:translateY(-100%)} 100%{transform:translateY(200vh)} }

        .avatar-glow {
            position:absolute;top:50%;left:50%;width:280px;height:280px;transform:translate(-50%,-50%);
            border-radius:50%;background:radial-gradient(circle,color-mix(in srgb,var(--accent-1) 15%,transparent) 0%,transparent 70%);
            animation:glowPulse 4s ease-in-out infinite;pointer-events:none;
        }
        @keyframes glowPulse { 0%,100%{opacity:.4;transform:translate(-50%,-50%) scale(1)} 50%{opacity:.8;transform:translate(-50%,-50%) scale(1.15)} }

        .avatar-container {
            width:260px;height:260px;position:relative;z-index:1;
            animation:float 6s ease-in-out infinite;
        }
        @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-12px)} }

        #avatarSvg { width:100%;height:100%; }

        .status-text {
            margin-top:1.5rem;font-size:1.1rem;font-weight:500;z-index:1;
            background:linear-gradient(90deg,var(--accent-1),var(--accent-2));
            -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
        }

        /* â”€â”€ Theme Selector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .theme-selector { display:flex;gap:.5rem;z-index:10; }
        .theme-btn {
            width:28px;height:28px;border-radius:50%;border:2px solid rgba(255,255,255,.15);
            cursor:pointer;transition:all .3s ease;position:relative;
        }
        .theme-btn:hover { transform:scale(1.2);border-color:rgba(255,255,255,.5); }
        .theme-btn.active { border-color:white;box-shadow:0 0 10px rgba(255,255,255,.3); }
        .theme-btn[data-theme="default"] { background:linear-gradient(135deg,#8b5cf6,#06b6d4); }
        .theme-btn[data-theme="matrix"] { background:linear-gradient(135deg,#00ff41,#003300); }
        .theme-btn[data-theme="god"] { background:linear-gradient(135deg,#ffd700,#ff6b00); }
        .theme-btn[data-theme="futuristic"] { background:linear-gradient(135deg,#ff00ff,#00ffff); }
        .theme-btn[data-theme="ascii"] { background:linear-gradient(135deg,#e94560,#0f3460); }
        .theme-btn[data-theme="ocean"] { background:linear-gradient(135deg,#64ffda,#020c1b); }
        .theme-btn .tooltip {
            position:absolute;bottom:120%;left:50%;transform:translateX(-50%);
            background:rgba(0,0,0,.85);color:white;padding:4px 8px;border-radius:4px;
            font-size:.7rem;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .2s;
        }
        .theme-btn:hover .tooltip { opacity:1; }

        /* â”€â”€ Chat Section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .chat-section {
            flex:1;display:flex;flex-direction:column;
            background:var(--bg-secondary);border-left:1px solid var(--border-color);min-width:0;
        }
        .chat-header {
            padding:1rem 1.5rem;border-bottom:1px solid var(--border-color);flex-shrink:0;
            background:linear-gradient(90deg,color-mix(in srgb,var(--accent-1) 10%,transparent),color-mix(in srgb,var(--accent-2) 10%,transparent));
            display:flex;align-items:center;justify-content:space-between;
        }
        .chat-header h1 {
            font-size:1.2rem;font-weight:600;
            background:linear-gradient(90deg,var(--accent-1),var(--accent-2));
            -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
        }
        .chat-header-left { display:flex;align-items:center;gap:.75rem; }
        .new-session-btn {
            width:32px;height:32px;background:transparent;border:1.5px solid var(--border-color);
            border-radius:.5rem;cursor:pointer;color:var(--text-secondary);
            display:flex;align-items:center;justify-content:center;transition:all .3s ease;
        }
        .new-session-btn:hover { border-color:var(--accent-1);color:var(--accent-1);background:color-mix(in srgb,var(--accent-1) 8%,transparent); }
        .new-session-btn svg { width:16px;height:16px;fill:none;stroke:currentColor;stroke-width:2;stroke-linecap:round;stroke-linejoin:round; }
        .new-session-btn .tooltip {
            position:absolute;top:120%;left:50%;transform:translateX(-50%);
            background:rgba(0,0,0,.85);color:white;padding:4px 8px;border-radius:4px;
            font-size:.7rem;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .2s;
        }
        .new-session-btn:hover .tooltip { opacity:1; }
        .new-session-btn { position:relative; }

        /* â”€â”€ Custom Confirm Dialog â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .confirm-overlay {
            position:fixed;top:0;left:0;width:100%;height:100%;
            background:rgba(0,0,0,.6);backdrop-filter:blur(4px);
            display:flex;align-items:center;justify-content:center;z-index:2000;
            opacity:0;pointer-events:none;transition:opacity .2s ease;
        }
        .confirm-overlay.active { opacity:1;pointer-events:auto; }
        .confirm-box {
            background:var(--bg-secondary);border:1px solid var(--border-color);
            border-radius:1rem;padding:1.75rem;max-width:340px;width:90%;
            text-align:center;animation:confirmPop .25s ease-out;
        }
        @keyframes confirmPop { from{transform:scale(.9);opacity:0} to{transform:scale(1);opacity:1} }
        .confirm-box p { margin-bottom:1.25rem;font-size:.95rem;line-height:1.5;color:var(--text-primary); }
        .confirm-actions { display:flex;gap:.75rem;justify-content:center; }
        .confirm-btn {
            padding:.6rem 1.5rem;border:none;border-radius:.75rem;font-family:var(--font-main);
            font-size:.9rem;font-weight:500;cursor:pointer;transition:all .2s ease;
        }
        .confirm-btn.primary {
            background:linear-gradient(135deg,var(--accent-1),var(--accent-2));color:white;
        }
        .confirm-btn.primary:hover { transform:translateY(-1px);box-shadow:0 4px 12px var(--glow-color); }
        .confirm-btn.secondary {
            background:transparent;color:var(--text-secondary);border:1.5px solid var(--border-color);
        }
        .confirm-btn.secondary:hover { border-color:var(--text-secondary);color:var(--text-primary); }
        .chat-messages {
            flex:1;overflow-y:auto;overflow-x:hidden;padding:1.5rem;
            display:flex;flex-direction:column;gap:.75rem;scroll-behavior:smooth;-webkit-overflow-scrolling:touch;
        }
        .chat-messages::-webkit-scrollbar { width:6px; }
        .chat-messages::-webkit-scrollbar-track { background:transparent; }
        .chat-messages::-webkit-scrollbar-thumb { background:color-mix(in srgb,var(--accent-1) 30%,transparent);border-radius:3px; }

        .message { display:flex;gap:.5rem;align-items:flex-end;animation:slideIn .3s ease-out; }
        @keyframes slideIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
        .message.user { flex-direction:row-reverse; }
        .message-content { max-width:75%;display:flex;flex-direction:column; }
        .message.user .message-content { align-items:flex-end; }
        .message-bubble { padding:.75rem 1rem;border-radius:1rem;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;font-size:.95rem; }
        .message-bubble p:last-child { margin-bottom:0 !important; }
        .message.user .message-bubble { background:var(--user-bubble);color:white;border-bottom-right-radius:.25rem; }
        .message.assistant .message-bubble { background:var(--assistant-bubble-bg);border:1px solid var(--assistant-bubble-border);color:var(--text-primary);border-bottom-left-radius:.25rem; }
        .message-time { font-size:.7rem;color:var(--text-secondary);margin-top:.25rem;padding:0 .25rem; }

        .chat-input-container { padding:1rem 1.5rem;border-top:1px solid var(--border-color);background:var(--bg-avatar);flex-shrink:0; }
        .input-wrapper { display:flex;gap:.75rem;align-items:flex-end; }
        .attach-button {
            width:44px;height:44px;background:transparent;
            color:var(--text-secondary);border:2px solid var(--border-color);border-radius:50%;
            font-size:1.2rem;cursor:pointer;transition:all .3s ease;
            display:flex;align-items:center;justify-content:center;flex-shrink:0;
        }
        .attach-button:hover { border-color:var(--accent-1);color:var(--accent-1); }
        .attach-button svg { width:20px;height:20px;fill:none;stroke:currentColor;stroke-width:2;stroke-linecap:round;stroke-linejoin:round; }
        .file-preview {
            display:none;padding:.5rem 1rem;border-top:1px solid var(--border-color);
            background:color-mix(in srgb,var(--accent-1) 5%,transparent);
            align-items:center;gap:.75rem;
        }
        .file-preview.active { display:flex; }
        .file-preview-thumb {
            width:48px;height:48px;border-radius:.5rem;object-fit:cover;
            border:1px solid var(--border-color);
        }
        .file-preview-icon {
            width:48px;height:48px;border-radius:.5rem;display:flex;align-items:center;justify-content:center;
            background:color-mix(in srgb,var(--accent-1) 10%,transparent);border:1px solid var(--border-color);
            color:var(--accent-1);font-size:1.2rem;
        }
        .file-preview-info { flex:1;min-width:0; }
        .file-preview-name { font-size:.85rem;color:var(--text-primary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap; }
        .file-preview-size { font-size:.7rem;color:var(--text-secondary); }
        .file-preview-remove {
            width:28px;height:28px;background:transparent;border:none;color:var(--text-secondary);
            cursor:pointer;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1rem;
        }
        .file-preview-remove:hover { color:#ef4444;background:rgba(239,68,68,.1); }
        .chat-input {
            flex:1;min-height:44px;max-height:120px;padding:.75rem 1rem;
            background:color-mix(in srgb,var(--accent-1) 5%,transparent);
            border:2px solid var(--border-color);border-radius:1.25rem;
            color:var(--text-primary);font-family:var(--font-main);font-size:.95rem;
            resize:none;transition:all .3s ease;line-height:1.4;
        }
        .chat-input:focus { outline:none;border-color:var(--accent-1);background:color-mix(in srgb,var(--accent-1) 8%,transparent); }
        .chat-input::placeholder { color:var(--text-secondary); }
        .send-button {
            width:44px;height:44px;background:linear-gradient(135deg,var(--accent-1),var(--accent-2));
            color:white;border:none;border-radius:50%;font-size:1.2rem;cursor:pointer;
            transition:all .3s ease;display:flex;align-items:center;justify-content:center;flex-shrink:0;
        }
        .send-button:hover { transform:scale(1.1);box-shadow:0 4px 15px var(--glow-color); }
        .send-button:active { transform:scale(.95); }
        .send-button:disabled { opacity:.4;cursor:not-allowed;transform:none; }
        .send-button svg { width:20px;height:20px;fill:white; }

        /* â”€â”€ Typing Indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .typing-indicator { display:flex;gap:.5rem;align-items:flex-end;animation:slideIn .3s ease-out; }
        .typing-indicator .message-content { max-width:75%; }
        .typing-bubble {
            padding:.75rem 1.25rem;border-radius:1rem;border-bottom-left-radius:.25rem;
            background:var(--assistant-bubble-bg);border:1px solid var(--assistant-bubble-border);
            display:flex;gap:5px;align-items:center;
        }
        .typing-dot {
            width:8px;height:8px;border-radius:50%;background:var(--accent-2);opacity:.4;
            animation:typingBounce 1.4s ease-in-out infinite;
        }
        .typing-dot:nth-child(2) { animation-delay:.2s; }
        .typing-dot:nth-child(3) { animation-delay:.4s; }
        @keyframes typingBounce { 0%,60%,100%{transform:translateY(0);opacity:.4} 30%{transform:translateY(-8px);opacity:1} }

        /* â”€â”€ Date Separator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .date-separator {
            display:flex;align-items:center;gap:1rem;margin:.5rem 0;
        }
        .date-separator::before, .date-separator::after {
            content:'';flex:1;height:1px;background:var(--border-color);
        }
        .date-separator span {
            font-size:.75rem;color:var(--text-secondary);white-space:nowrap;
            padding:.25rem .75rem;background:color-mix(in srgb,var(--accent-1) 8%,transparent);
            border-radius:1rem;border:1px solid var(--border-color);
        }

        /* â”€â”€ Login Overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .login-overlay {
            position:fixed;top:0;left:0;width:100%;height:100%;background:var(--bg-primary);
            display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000;gap:1.5rem;
        }
        .login-overlay.hidden { display:none; }
        .login-title { font-size:2rem;font-weight:700;background:linear-gradient(90deg,var(--accent-1),var(--accent-2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text; }
        .login-subtitle { color:var(--text-secondary);font-size:.95rem; }
        .login-input {
            width:320px;max-width:85vw;padding:.85rem 1.25rem;
            background:color-mix(in srgb,var(--accent-1) 5%,transparent);
            border:2px solid var(--border-color);border-radius:.75rem;
            color:var(--text-primary);font-family:var(--font-mono);font-size:.9rem;
            transition:all .3s ease;text-align:center;
        }
        .login-input:focus { outline:none;border-color:var(--accent-1);background:color-mix(in srgb,var(--accent-1) 8%,transparent); }
        .login-input::placeholder { color:var(--text-secondary);font-family:var(--font-main); }
        .login-button {
            padding:.75rem 2.5rem;background:linear-gradient(135deg,var(--accent-1),var(--accent-2));
            color:white;border:none;border-radius:.75rem;font-family:var(--font-main);font-size:1rem;font-weight:600;
            cursor:pointer;transition:all .3s ease;
        }
        .login-button:hover { transform:translateY(-2px);box-shadow:0 6px 20px var(--glow-color); }
        .login-error { color:#ef4444;font-size:.85rem;min-height:1.2rem; }

        /* â”€â”€ ASCII Face â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .ascii-face {
            display:none;font-family:'JetBrains Mono',monospace;font-size:1rem;line-height:1.25;
            color:var(--accent-1);text-align:center;white-space:pre;z-index:2;
            text-shadow:0 0 10px var(--glow-color);
        }
        [data-theme="ascii"] .ascii-face { display:block; }
        [data-theme="ascii"] #avatarSvg { display:none; }
        [data-theme="ascii"] .avatar-glow { display:none; }

        /* â”€â”€ Mobile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media (max-width:768px) {
            .container { flex-direction:column; }
            .avatar-section { flex:0 0 auto;padding:1rem;min-height:180px; }
            .avatar-container { width:120px;height:120px; }
            .avatar-glow { width:140px;height:140px; }
            .status-text { font-size:.85rem;margin-top:.5rem; }
            .theme-selector { margin-top:0; }
            .theme-btn { width:24px;height:24px; }
            .chat-section { border-left:none;border-top:1px solid var(--border-color);flex:1;min-height:0; }
            .chat-header { padding:.75rem 1rem; }
            .chat-header h1 { font-size:1rem; }
            .chat-messages { padding:1rem; }
            .message-content { max-width:85%; }
            .message-bubble { font-size:.9rem;padding:.65rem .85rem; }
            .chat-input-container { padding:.75rem 1rem; }
            .chat-input { font-size:.9rem;min-height:40px; }
            .send-button { width:40px;height:40px; }
            .attach-button { width:40px;height:40px; }
        }
        @media (max-width:400px) {
            .avatar-section { min-height:140px;padding:.75rem; }
            .avatar-container { width:90px;height:90px; }
            .avatar-glow { width:110px;height:110px; }
        }
    </style>
</head>
<body>
    <div class="login-overlay" id="loginOverlay">
        <div class="login-title" id="loginTitle"></div>
        <div class="login-subtitle" id="loginSubtitle"></div>
        <input type="password" class="login-input" id="tokenInput" placeholder="" autocomplete="off" spellcheck="false">
        <button class="login-button" id="loginButton"></button>
        <div class="login-error" id="loginError"></div>
    </div>

    <div class="confirm-overlay" id="confirmOverlay">
        <div class="confirm-box">
            <p id="confirmText"></p>
            <div class="confirm-actions">
                <button class="confirm-btn secondary" id="confirmCancel"></button>
                <button class="confirm-btn primary" id="confirmOk"></button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="avatar-section">
            <div class="bg-particles" id="bgParticles"></div>
            <div class="matrix-rain" id="matrixRain"></div>
            <div class="avatar-glow"></div>
            <div class="avatar-container">
                <svg id="avatarSvg" viewBox="0 0 320 320" xmlns="http://www.w3.org/2000/svg"></svg>
                <div class="ascii-face" id="asciiFace"></div>
            </div>
            <div class="status-text" id="statusText"></div>
        </div>
        <div class="chat-section">
            <div class="chat-header">
                <div class="chat-header-left">
                    <h1 id="chatTitle"></h1>
                    <button class="new-session-btn" id="newSessionBtn" title="">
                        <svg viewBox="0 0 24 24"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/></svg>
                        <span class="tooltip" id="newSessionTooltip"></span>
                    </button>
                </div>
                <div class="theme-selector">
                    <button class="theme-btn active" data-theme="default" onclick="setTheme('default')"><span class="tooltip">Cyberpunk</span></button>
                    <button class="theme-btn" data-theme="matrix" onclick="setTheme('matrix')"><span class="tooltip">Matrix</span></button>
                    <button class="theme-btn" data-theme="god" onclick="setTheme('god')"><span class="tooltip">God Mode</span></button>
                    <button class="theme-btn" data-theme="futuristic" onclick="setTheme('futuristic')"><span class="tooltip">Neon</span></button>
                    <button class="theme-btn" data-theme="ascii" onclick="setTheme('ascii')"><span class="tooltip">ASCII</span></button>
                    <button class="theme-btn" data-theme="ocean" onclick="setTheme('ocean')"><span class="tooltip">Ocean</span></button>
                </div>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-container">
                <div class="file-preview" id="filePreview">
                    <div id="fileThumb"></div>
                    <div class="file-preview-info">
                        <div class="file-preview-name" id="fileName"></div>
                        <div class="file-preview-size" id="fileSize"></div>
                    </div>
                    <button class="file-preview-remove" id="fileRemove" title="">âœ•</button>
                </div>
                <div class="input-wrapper">
                    <button id="attachButton" class="attach-button" title="">
                        <svg viewBox="0 0 24 24"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
                    </button>
                    <input type="file" id="fileInput" style="display:none" accept="">
                    <textarea id="chatInput" class="chat-input" placeholder="" rows="1"></textarea>
                    <button id="sendButton" class="send-button" title="">
                        <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STRINGS â€” Localized UI text
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STRINGS = {
    en: {
        tokenPrompt: 'Enter your token to continue',
        tokenPlaceholder: 'Token',
        connect: 'Connect',
        tokenEmpty: 'Token cannot be empty',
        tokenInvalid: 'Invalid token',
        ready: 'Ready',
        connecting: 'Connecting...',
        thinking: 'Thinking...',
        working: 'Working...',
        speaking: 'Speaking...',
        listening: 'Listening...',
        connectionError: 'Connection error',
        disconnected: 'Disconnected â€” reconnecting...',
        sessionExpired: 'Session expired',
        newSession: 'New Session',
        newSessionConfirm: 'Clear current session and start fresh?',
        newSessionStarted: 'New session started! ğŸ¤– How can I help?',
        welcomeMessage: 'Connected! ğŸ¤– How can I help you?',
        messagePlaceholder: 'Type your message...',
        attachFile: 'Attach file',
        send: 'Send',
        remove: 'Remove',
        cancel: 'Cancel',
        confirm: 'Yes',
        fileTooLarge: 'File too large ({size}). Maximum: {max}',
        fileReadError: 'Could not read file',
        fileUploadError: 'File upload failed: ',
        analyzeFile: 'Analyze this file: ',
        today: 'Today',
        yesterday: 'Yesterday',
        starting: 'Starting...',
        disconnectedRetrying: 'Disconnected: ',
        error: 'Error: '
    },
    tr: {
        tokenPrompt: 'Devam etmek iÃ§in token girin',
        tokenPlaceholder: 'Token',
        connect: 'BaÄŸlan',
        tokenEmpty: 'Token boÅŸ olamaz',
        tokenInvalid: 'GeÃ§ersiz token',
        ready: 'HazÄ±r',
        connecting: 'BaÄŸlanÄ±yor...',
        thinking: 'DÃ¼ÅŸÃ¼nÃ¼yorum...',
        working: 'Ã‡alÄ±ÅŸÄ±yorum...',
        speaking: 'KonuÅŸuyorum...',
        listening: 'Dinliyorum...',
        connectionError: 'BaÄŸlantÄ± hatasÄ±',
        disconnected: 'Koptu â€” tekrar deneniyor...',
        sessionExpired: 'Oturum sona erdi',
        newSession: 'Yeni Oturum',
        newSessionConfirm: 'Mevcut oturumu temizleyip yeni bir oturum baÅŸlatmak istiyor musun?',
        newSessionStarted: 'Yeni oturum baÅŸlatÄ±ldÄ±! ğŸ¤– NasÄ±l yardÄ±mcÄ± olabilirim?',
        welcomeMessage: 'BaÄŸlandÄ±m! ğŸ¤– NasÄ±l yardÄ±mcÄ± olabilirim?',
        messagePlaceholder: 'MesajÄ±nÄ± yaz...',
        attachFile: 'Dosya ekle',
        send: 'GÃ¶nder',
        remove: 'KaldÄ±r',
        cancel: 'VazgeÃ§',
        confirm: 'Evet',
        fileTooLarge: 'Dosya Ã§ok bÃ¼yÃ¼k ({size}). Maksimum: {max}',
        fileReadError: 'Dosya okunamadÄ±',
        fileUploadError: 'Dosya yÃ¼klenemedi: ',
        analyzeFile: 'Bu dosyayÄ± analiz et: ',
        today: 'BugÃ¼n',
        yesterday: 'DÃ¼n',
        starting: 'BaÅŸlatÄ±lÄ±yor...',
        disconnectedRetrying: 'Koptu: ',
        error: 'Hata: '
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG INITIALIZATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CFG = window.CLAWDBOT_WEBCHAT_CONFIG || {};
const L = {...STRINGS[CFG.locale||'en'], ...(CFG.strings||{})};

// Set document language
document.documentElement.lang = CFG.locale || 'en';

// Set dynamic title
document.title = CFG.name || 'Clawdbot';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FACE DEFINITIONS â€” Each theme gets a unique face SVG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FACES = {};

// â”€â”€ Cyberpunk (default) â€” Robot head, antenna, headphones â”€â”€
FACES['default'] = `
<defs>
  <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
    <stop offset="0%" stop-color="#8b5cf6"/><stop offset="100%" stop-color="#06b6d4"/>
  </linearGradient>
  <linearGradient id="grad1g" x1="0%" y1="0%" x2="100%" y2="100%">
    <stop offset="0%" stop-color="#8b5cf6" stop-opacity="0.6"/><stop offset="100%" stop-color="#06b6d4" stop-opacity="0.6"/>
  </linearGradient>
  <filter id="glow"><feGaussianBlur stdDeviation="3" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
</defs>
<!-- orbit -->
<g class="face-orbit">
  <circle r="3" fill="#8b5cf6" opacity=".6" filter="url(#glow)"><animateMotion dur="6s" repeatCount="indefinite" path="M160,40 A120,120 0 1,1 159,40 Z"/><animate attributeName="opacity" values=".2;.8;.2" dur="6s" repeatCount="indefinite"/></circle>
  <circle r="2" fill="#06b6d4" opacity=".4" filter="url(#glow)"><animateMotion dur="8s" repeatCount="indefinite" path="M160,30 A130,130 0 1,0 161,30 Z"/></circle>
</g>
<circle id="workingRing" cx="160" cy="160" r="140" fill="none" stroke="url(#grad1)" stroke-width="3" stroke-dasharray="20 10" opacity="0" filter="url(#glow)">
  <animateTransform id="ringRotate" attributeName="transform" type="rotate" from="0 160 160" to="360 160 160" dur="2s" repeatCount="0"/>
</circle>
<!-- head -->
<circle cx="160" cy="160" r="80" fill="#0a0a12" stroke="url(#grad1)" stroke-width="3"/>
<circle cx="160" cy="140" r="60" fill="url(#grad1g)" opacity=".05"><animate attributeName="opacity" values=".03;.08;.03" dur="4s" repeatCount="indefinite"/></circle>
<!-- antenna -->
<line x1="160" y1="80" x2="160" y2="50" stroke="url(#grad1)" stroke-width="2.5"/>
<circle cx="160" cy="45" r="6" fill="url(#grad1)" filter="url(#glow)"><animate attributeName="opacity" values="1;.4;1" dur="2s" repeatCount="indefinite"/><animate attributeName="r" values="6;7;6" dur="2s" repeatCount="indefinite"/></circle>
<circle cx="160" cy="45" r="12" fill="none" stroke="#8b5cf6" stroke-width="1" opacity="0"><animate attributeName="r" values="8;20" dur="2s" repeatCount="indefinite"/><animate attributeName="opacity" values=".5;0" dur="2s" repeatCount="indefinite"/></circle>
<!-- ears -->
<ellipse cx="90" cy="160" rx="15" ry="25" fill="#0a0a12" stroke="url(#grad1)" stroke-width="2.5"/>
<ellipse cx="90" cy="160" rx="8" ry="15" fill="url(#grad1g)"><animate attributeName="opacity" values=".6;.3;.6" dur="3s" repeatCount="indefinite"/></ellipse>
<ellipse cx="230" cy="160" rx="15" ry="25" fill="#0a0a12" stroke="url(#grad1)" stroke-width="2.5"/>
<ellipse cx="230" cy="160" rx="8" ry="15" fill="url(#grad1g)"><animate attributeName="opacity" values=".3;.6;.3" dur="3s" repeatCount="indefinite"/></ellipse>
<!-- eyes -->
<g id="leftEye"><circle cx="135" cy="150" r="18" fill="rgba(6,182,212,.2)"/><circle id="leftPupil" cx="135" cy="150" r="10" fill="url(#grad1)" filter="url(#glow)"/><circle cx="138" cy="147" r="3" fill="white" opacity=".8"/></g>
<g id="rightEye"><circle cx="185" cy="150" r="18" fill="rgba(6,182,212,.2)"/><circle id="rightPupil" cx="185" cy="150" r="10" fill="url(#grad1)" filter="url(#glow)"/><circle cx="188" cy="147" r="3" fill="white" opacity=".8"/></g>
<rect id="leftEyelid" x="117" y="132" width="36" height="0" fill="#0a0a12" opacity="0"/>
<rect id="rightEyelid" x="167" y="132" width="36" height="0" fill="#0a0a12" opacity="0"/>
<!-- mouth -->
<path id="mouthSmile" d="M 130 190 Q 160 205 190 190" stroke="url(#grad1)" stroke-width="3" fill="none" filter="url(#glow)"/>
<g id="mouthBars" opacity="0">
  <rect x="138" y="185" width="5" height="15" fill="url(#grad1)" rx="2.5" filter="url(#glow)"><animate attributeName="height" values="15;28;15" dur=".4s" repeatCount="indefinite"/><animate attributeName="y" values="185;172;185" dur=".4s" repeatCount="indefinite"/></rect>
  <rect x="149" y="180" width="5" height="20" fill="url(#grad1)" rx="2.5" filter="url(#glow)"><animate attributeName="height" values="20;35;20" dur=".5s" repeatCount="indefinite"/><animate attributeName="y" values="180;165;180" dur=".5s" repeatCount="indefinite"/></rect>
  <rect x="160" y="175" width="5" height="30" fill="url(#grad1)" rx="2.5" filter="url(#glow)"><animate attributeName="height" values="30;42;30" dur=".3s" repeatCount="indefinite"/><animate attributeName="y" values="175;163;175" dur=".3s" repeatCount="indefinite"/></rect>
  <rect x="171" y="178" width="5" height="22" fill="url(#grad1)" rx="2.5" filter="url(#glow)"><animate attributeName="height" values="22;32;22" dur=".45s" repeatCount="indefinite"/><animate attributeName="y" values="178;168;178" dur=".45s" repeatCount="indefinite"/></rect>
  <rect x="182" y="183" width="5" height="17" fill="url(#grad1)" rx="2.5" filter="url(#glow)"><animate attributeName="height" values="17;26;17" dur=".35s" repeatCount="indefinite"/><animate attributeName="y" values="183;174;183" dur=".35s" repeatCount="indefinite"/></rect>
</g>
<g id="thinkingParticles" opacity="0"></g>
`;

// â”€â”€ Matrix â€” Digital skull, binary streams through face â”€â”€
FACES['matrix'] = `
<defs>
  <filter id="glow"><feGaussianBlur stdDeviation="4" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
  <filter id="glitch">
    <feTurbulence type="fractalNoise" baseFrequency="0.05" numOctaves="1" result="noise" seed="2"/>
    <feDisplacementMap in="SourceGraphic" in2="noise" scale="3" xChannelSelector="R" yChannelSelector="G"/>
  </filter>
</defs>
<!-- digital grid bg -->
<g opacity=".15">
  <line x1="80" y1="60" x2="80" y2="260" stroke="#00ff41" stroke-width=".5"/><line x1="120" y1="60" x2="120" y2="260" stroke="#00ff41" stroke-width=".5"/>
  <line x1="160" y1="60" x2="160" y2="260" stroke="#00ff41" stroke-width=".5"/><line x1="200" y1="60" x2="200" y2="260" stroke="#00ff41" stroke-width=".5"/>
  <line x1="240" y1="60" x2="240" y2="260" stroke="#00ff41" stroke-width=".5"/>
</g>
<circle id="workingRing" cx="160" cy="160" r="140" fill="none" stroke="#00ff41" stroke-width="2" stroke-dasharray="5 15" opacity="0">
  <animateTransform id="ringRotate" attributeName="transform" type="rotate" from="0 160 160" to="360 160 160" dur="2s" repeatCount="0"/>
</circle>
<!-- skull shape -->
<path d="M100,170 Q100,80 160,75 Q220,80 220,170 Q220,200 200,210 L200,225 Q200,235 190,235 L130,235 Q120,235 120,225 L120,210 Q100,200 100,170 Z" fill="none" stroke="#00ff41" stroke-width="2.5" filter="url(#glow)"/>
<!-- jaw -->
<path d="M125,235 L130,255 Q160,265 190,255 L195,235" fill="none" stroke="#00ff41" stroke-width="2" opacity=".7"/>
<!-- eyes â€” binary display -->
<g id="leftEye">
  <rect x="120" y="135" width="35" height="25" rx="3" fill="#000800" stroke="#00ff41" stroke-width="1.5"/>
  <circle id="leftPupil" cx="137" cy="148" r="0" fill="none"/>
  <text x="123" y="152" fill="#00ff41" font-family="'JetBrains Mono',monospace" font-size="11" filter="url(#glow)">0 1 0</text>
</g>
<g id="rightEye">
  <rect x="165" y="135" width="35" height="25" rx="3" fill="#000800" stroke="#00ff41" stroke-width="1.5"/>
  <circle id="rightPupil" cx="182" cy="148" r="0" fill="none"/>
  <text x="168" y="152" fill="#00ff41" font-family="'JetBrains Mono',monospace" font-size="11" filter="url(#glow)">1 0 1</text>
</g>
<rect id="leftEyelid" x="120" y="135" width="35" height="0" fill="#000800" opacity="0"/>
<rect id="rightEyelid" x="165" y="135" width="35" height="0" fill="#000800" opacity="0"/>
<!-- nose -->
<path d="M155,170 L160,180 L165,170" fill="none" stroke="#00ff41" stroke-width="1.5" opacity=".5"/>
<!-- mouth â€” data stream -->
<path id="mouthSmile" d="M 135 200 Q 160 210 185 200" stroke="#00ff41" stroke-width="2" fill="none" filter="url(#glow)"/>
<g id="mouthBars" opacity="0">
  <text x="130" y="210" fill="#00ff41" font-family="'JetBrains Mono',monospace" font-size="9" filter="url(#glow)">
    <animate attributeName="textContent" values="01101;10010;11001;00110" dur=".6s" repeatCount="indefinite"/>
    01101
  </text>
  <rect x="130" y="195" width="60" height="2" fill="#00ff41" opacity=".8"><animate attributeName="width" values="60;20;50;60" dur=".4s" repeatCount="indefinite"/></rect>
  <rect x="135" y="200" width="50" height="2" fill="#00ff41" opacity=".6"><animate attributeName="width" values="50;40;10;50" dur=".3s" repeatCount="indefinite"/></rect>
  <rect x="140" y="205" width="40" height="2" fill="#00ff41" opacity=".4"><animate attributeName="width" values="40;55;30;40" dur=".5s" repeatCount="indefinite"/></rect>
</g>
<!-- streaming binary along face -->
<text x="105" y="100" fill="#00ff41" font-family="'JetBrains Mono',monospace" font-size="8" opacity=".4">
  <animate attributeName="y" values="80;260" dur="4s" repeatCount="indefinite"/>
  <animate attributeName="opacity" values="0;.4;0" dur="4s" repeatCount="indefinite"/>
  10110100
</text>
<text x="205" y="130" fill="#00ff41" font-family="'JetBrains Mono',monospace" font-size="8" opacity=".3">
  <animate attributeName="y" values="70;250" dur="5s" repeatCount="indefinite"/>
  <animate attributeName="opacity" values="0;.3;0" dur="5s" repeatCount="indefinite"/>
  01001011
</text>
<g id="thinkingParticles" opacity="0"></g>
`;

// â”€â”€ God Mode â€” All-seeing eye, halo, divine geometry â”€â”€
FACES['god'] = `
<defs>
  <linearGradient id="godGrad" x1="0%" y1="0%" x2="100%" y2="100%">
    <stop offset="0%" stop-color="#ffd700"/><stop offset="100%" stop-color="#ff6b00"/>
  </linearGradient>
  <filter id="glow"><feGaussianBlur stdDeviation="4" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
  <filter id="holyGlow"><feGaussianBlur stdDeviation="8" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
</defs>
<circle id="workingRing" cx="160" cy="160" r="140" fill="none" stroke="url(#godGrad)" stroke-width="3" stroke-dasharray="20 10" opacity="0">
  <animateTransform id="ringRotate" attributeName="transform" type="rotate" from="0 160 160" to="360 160 160" dur="2s" repeatCount="0"/>
</circle>
<!-- sacred geometry â€” rotating triangle -->
<g opacity=".2"><polygon points="160,50 260,230 60,230" fill="none" stroke="#ffd700" stroke-width="1.5">
  <animateTransform attributeName="transform" type="rotate" from="0 160 160" to="360 160 160" dur="30s" repeatCount="indefinite"/>
</polygon>
<polygon points="160,270 60,90 260,90" fill="none" stroke="#ff6b00" stroke-width="1.5">
  <animateTransform attributeName="transform" type="rotate" from="0 160 160" to="-360 160 160" dur="30s" repeatCount="indefinite"/>
</polygon></g>
<!-- halo -->
<ellipse cx="160" cy="75" rx="55" ry="12" fill="none" stroke="#ffd700" stroke-width="2.5" filter="url(#holyGlow)">
  <animate attributeName="ry" values="12;15;12" dur="3s" repeatCount="indefinite"/>
</ellipse>
<ellipse cx="160" cy="75" rx="55" ry="12" fill="none" stroke="#ffd700" stroke-width="1" opacity=".4">
  <animate attributeName="ry" values="15;18;15" dur="3s" repeatCount="indefinite"/>
</ellipse>
<!-- face â€” smooth divine -->
<ellipse cx="160" cy="165" rx="70" ry="80" fill="#08030d" stroke="url(#godGrad)" stroke-width="2.5"/>
<!-- third eye -->
<g filter="url(#holyGlow)">
  <path d="M140,105 Q160,95 180,105 Q160,115 140,105 Z" fill="none" stroke="#ffd700" stroke-width="1.5"/>
  <circle cx="160" cy="105" r="5" fill="#ffd700"><animate attributeName="r" values="4;6;4" dur="2s" repeatCount="indefinite"/><animate attributeName="opacity" values=".7;1;.7" dur="2s" repeatCount="indefinite"/></circle>
</g>
<!-- eyes â€” almond shape -->
<g id="leftEye">
  <path d="M110,150 Q135,135 155,150 Q135,165 110,150 Z" fill="none" stroke="#ffd700" stroke-width="2"/>
  <circle id="leftPupil" cx="135" cy="150" r="8" fill="url(#godGrad)" filter="url(#glow)"/>
  <circle cx="137" cy="148" r="2.5" fill="white" opacity=".7"/>
</g>
<g id="rightEye">
  <path d="M165,150 Q185,135 210,150 Q185,165 165,150 Z" fill="none" stroke="#ffd700" stroke-width="2"/>
  <circle id="rightPupil" cx="185" cy="150" r="8" fill="url(#godGrad)" filter="url(#glow)"/>
  <circle cx="187" cy="148" r="2.5" fill="white" opacity=".7"/>
</g>
<rect id="leftEyelid" x="110" y="138" width="50" height="0" fill="#08030d" opacity="0"/>
<rect id="rightEyelid" x="165" y="138" width="50" height="0" fill="#08030d" opacity="0"/>
<!-- mouth -->
<path id="mouthSmile" d="M 135 195 Q 160 208 185 195" stroke="url(#godGrad)" stroke-width="2.5" fill="none" filter="url(#glow)"/>
<g id="mouthBars" opacity="0">
  <rect x="140" y="190" width="4" height="12" fill="#ffd700" rx="2" filter="url(#glow)"><animate attributeName="height" values="12;24;12" dur=".4s" repeatCount="indefinite"/><animate attributeName="y" values="190;178;190" dur=".4s" repeatCount="indefinite"/></rect>
  <rect x="148" y="188" width="4" height="16" fill="#ffd700" rx="2" filter="url(#glow)"><animate attributeName="height" values="16;28;16" dur=".5s" repeatCount="indefinite"/><animate attributeName="y" values="188;176;188" dur=".5s" repeatCount="indefinite"/></rect>
  <rect x="156" y="185" width="4" height="22" fill="#ffd700" rx="2" filter="url(#glow)"><animate attributeName="height" values="22;34;22" dur=".3s" repeatCount="indefinite"/><animate attributeName="y" values="185;173;185" dur=".3s" repeatCount="indefinite"/></rect>
  <rect x="164" y="187" width="4" height="18" fill="#ffd700" rx="2" filter="url(#glow)"><animate attributeName="height" values="18;28;18" dur=".45s" repeatCount="indefinite"/><animate attributeName="y" values="187;177;187" dur=".45s" repeatCount="indefinite"/></rect>
  <rect x="172" y="190" width="4" height="12" fill="#ffd700" rx="2" filter="url(#glow)"><animate attributeName="height" values="12;20;12" dur=".38s" repeatCount="indefinite"/><animate attributeName="y" values="190;182;190" dur=".38s" repeatCount="indefinite"/></rect>
</g>
<!-- floating runes -->
<text x="75" y="120" fill="#ffd700" font-size="16" opacity=".3" filter="url(#glow)"><animate attributeName="opacity" values=".1;.4;.1" dur="5s" repeatCount="indefinite"/>â˜¥</text>
<text x="235" y="200" fill="#ff6b00" font-size="14" opacity=".3" filter="url(#glow)"><animate attributeName="opacity" values=".2;.5;.2" dur="4s" repeatCount="indefinite"/>âœ¦</text>
<text x="80" y="220" fill="#ffd700" font-size="12" opacity=".2"><animate attributeName="opacity" values=".1;.3;.1" dur="6s" repeatCount="indefinite"/>âˆ</text>
<g id="thinkingParticles" opacity="0"></g>
`;

// â”€â”€ Futuristic/Neon â€” Hologram visor face, scan lines â”€â”€
FACES['futuristic'] = `
<defs>
  <linearGradient id="neonGrad" x1="0%" y1="0%" x2="100%" y2="100%">
    <stop offset="0%" stop-color="#ff00ff"/><stop offset="100%" stop-color="#00ffff"/>
  </linearGradient>
  <filter id="glow"><feGaussianBlur stdDeviation="3" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
</defs>
<circle id="workingRing" cx="160" cy="160" r="140" fill="none" stroke="url(#neonGrad)" stroke-width="3" stroke-dasharray="20 10" opacity="0">
  <animateTransform id="ringRotate" attributeName="transform" type="rotate" from="0 160 160" to="360 160 160" dur="2s" repeatCount="0"/>
</circle>
<!-- hex grid bg -->
<g opacity=".1">
  <polygon points="160,60 185,75 185,105 160,120 135,105 135,75" fill="none" stroke="#ff00ff" stroke-width="1"/>
  <polygon points="120,100 145,115 145,145 120,160 95,145 95,115" fill="none" stroke="#00ffff" stroke-width="1"/>
  <polygon points="200,100 225,115 225,145 200,160 175,145 175,115" fill="none" stroke="#ff00ff" stroke-width="1"/>
  <polygon points="160,140 185,155 185,185 160,200 135,185 135,155" fill="none" stroke="#00ffff" stroke-width="1"/>
</g>
<!-- helmet/head â€” angular -->
<path d="M95,140 L105,85 Q160,65 215,85 L225,140 L220,200 Q160,230 100,200 Z" fill="#07000f" stroke="url(#neonGrad)" stroke-width="2.5" stroke-linejoin="round"/>
<!-- visor -->
<path d="M110,130 L210,130 L205,165 Q160,175 115,165 Z" fill="rgba(0,255,255,.05)" stroke="#00ffff" stroke-width="2" filter="url(#glow)"/>
<!-- scan line -->
<line x1="110" y1="140" x2="210" y2="140" stroke="#ff00ff" stroke-width="1" opacity=".6">
  <animate attributeName="y1" values="130;165;130" dur="2s" repeatCount="indefinite"/>
  <animate attributeName="y2" values="130;165;130" dur="2s" repeatCount="indefinite"/>
  <animate attributeName="opacity" values=".3;.7;.3" dur="2s" repeatCount="indefinite"/>
</line>
<!-- eyes â€” diamond shape -->
<g id="leftEye">
  <path d="M125,148 L140,138 L155,148 L140,158 Z" fill="none" stroke="#ff00ff" stroke-width="1.5"/>
  <circle id="leftPupil" cx="140" cy="148" r="6" fill="#ff00ff" filter="url(#glow)"/>
  <circle cx="142" cy="146" r="2" fill="white" opacity=".6"/>
</g>
<g id="rightEye">
  <path d="M165,148 L180,138 L195,148 L180,158 Z" fill="none" stroke="#00ffff" stroke-width="1.5"/>
  <circle id="rightPupil" cx="180" cy="148" r="6" fill="#00ffff" filter="url(#glow)"/>
  <circle cx="182" cy="146" r="2" fill="white" opacity=".6"/>
</g>
<rect id="leftEyelid" x="125" y="138" width="30" height="0" fill="#07000f" opacity="0"/>
<rect id="rightEyelid" x="165" y="138" width="30" height="0" fill="#07000f" opacity="0"/>
<!-- mouth â€” horizontal line display -->
<path id="mouthSmile" d="M 130 195 L 190 195" stroke="url(#neonGrad)" stroke-width="2" fill="none" filter="url(#glow)"/>
<g id="mouthBars" opacity="0">
  <rect x="130" y="190" width="60" height="3" fill="#ff00ff" rx="1.5" filter="url(#glow)"><animate attributeName="width" values="60;30;50;60" dur=".4s" repeatCount="indefinite"/></rect>
  <rect x="135" y="196" width="50" height="3" fill="#00ffff" rx="1.5" filter="url(#glow)"><animate attributeName="width" values="50;55;25;50" dur=".5s" repeatCount="indefinite"/></rect>
  <rect x="140" y="202" width="40" height="3" fill="#ff00ff" rx="1.5" filter="url(#glow)"><animate attributeName="width" values="40;20;45;40" dur=".35s" repeatCount="indefinite"/></rect>
</g>
<!-- HUD text -->
<text x="100" y="80" fill="#00ffff" font-family="'JetBrains Mono',monospace" font-size="8" opacity=".4">SYS.ONLINE</text>
<text x="185" y="225" fill="#ff00ff" font-family="'JetBrains Mono',monospace" font-size="7" opacity=".3">v2.0.26</text>
<g id="thinkingParticles" opacity="0"></g>
`;

// â”€â”€ Ocean â€” Deep sea creature, bioluminescent â”€â”€
FACES['ocean'] = `
<defs>
  <linearGradient id="oceanGrad" x1="0%" y1="0%" x2="100%" y2="100%">
    <stop offset="0%" stop-color="#64ffda"/><stop offset="100%" stop-color="#5cc9f5"/>
  </linearGradient>
  <filter id="glow"><feGaussianBlur stdDeviation="4" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
  <radialGradient id="bioGlow" cx="50%" cy="50%" r="50%">
    <stop offset="0%" stop-color="#64ffda" stop-opacity=".4"/><stop offset="100%" stop-color="#64ffda" stop-opacity="0"/>
  </radialGradient>
</defs>
<circle id="workingRing" cx="160" cy="160" r="140" fill="none" stroke="url(#oceanGrad)" stroke-width="3" stroke-dasharray="20 10" opacity="0">
  <animateTransform id="ringRotate" attributeName="transform" type="rotate" from="0 160 160" to="360 160 160" dur="2s" repeatCount="0"/>
</circle>
<!-- bubbles -->
<circle cx="80" cy="250" r="4" fill="none" stroke="#64ffda" stroke-width="1" opacity=".4">
  <animate attributeName="cy" values="260;60" dur="6s" repeatCount="indefinite"/><animate attributeName="opacity" values="0;.4;0" dur="6s" repeatCount="indefinite"/>
</circle>
<circle cx="240" cy="200" r="3" fill="none" stroke="#5cc9f5" stroke-width="1" opacity=".3">
  <animate attributeName="cy" values="240;40" dur="8s" repeatCount="indefinite"/><animate attributeName="opacity" values="0;.3;0" dur="8s" repeatCount="indefinite"/>
</circle>
<circle cx="100" cy="180" r="2" fill="none" stroke="#64ffda" stroke-width="1" opacity=".3">
  <animate attributeName="cy" values="220;50" dur="7s" repeatCount="indefinite"/><animate attributeName="opacity" values="0;.3;0" dur="7s" repeatCount="indefinite"/>
</circle>
<!-- jellyfish head -->
<path d="M90,160 Q90,80 160,75 Q230,80 230,160" fill="#061222" stroke="url(#oceanGrad)" stroke-width="2.5"/>
<!-- dome bio glow -->
<ellipse cx="160" cy="120" rx="50" ry="35" fill="url(#bioGlow)"><animate attributeName="opacity" values=".3;.6;.3" dur="3s" repeatCount="indefinite"/></ellipse>
<!-- tentacles -->
<path d="M100,160 Q95,200 105,230 Q110,245 100,260" fill="none" stroke="#64ffda" stroke-width="2" opacity=".5">
  <animate attributeName="d" values="M100,160 Q95,200 105,230 Q110,245 100,260;M100,160 Q110,200 95,230 Q90,245 105,260;M100,160 Q95,200 105,230 Q110,245 100,260" dur="4s" repeatCount="indefinite"/>
</path>
<path d="M130,160 Q125,210 135,250" fill="none" stroke="#5cc9f5" stroke-width="2" opacity=".4">
  <animate attributeName="d" values="M130,160 Q125,210 135,250;M130,160 Q140,210 125,250;M130,160 Q125,210 135,250" dur="3.5s" repeatCount="indefinite"/>
</path>
<path d="M190,160 Q195,210 185,250" fill="none" stroke="#5cc9f5" stroke-width="2" opacity=".4">
  <animate attributeName="d" values="M190,160 Q195,210 185,250;M190,160 Q180,210 195,250;M190,160 Q195,210 185,250" dur="3.8s" repeatCount="indefinite"/>
</path>
<path d="M220,160 Q225,200 215,230 Q210,245 220,260" fill="none" stroke="#64ffda" stroke-width="2" opacity=".5">
  <animate attributeName="d" values="M220,160 Q225,200 215,230 Q210,245 220,260;M220,160 Q210,200 225,230 Q230,245 215,260;M220,160 Q225,200 215,230 Q210,245 220,260" dur="4.2s" repeatCount="indefinite"/>
</path>
<!-- eyes â€” round bioluminescent -->
<g id="leftEye">
  <circle cx="135" cy="125" r="18" fill="rgba(100,255,218,.1)"/>
  <circle cx="135" cy="125" r="12" fill="rgba(100,255,218,.08)" stroke="#64ffda" stroke-width="1"/>
  <circle id="leftPupil" cx="135" cy="125" r="7" fill="url(#oceanGrad)" filter="url(#glow)"/>
  <circle cx="137" cy="123" r="2.5" fill="white" opacity=".7"/>
</g>
<g id="rightEye">
  <circle cx="185" cy="125" r="18" fill="rgba(92,201,245,.1)"/>
  <circle cx="185" cy="125" r="12" fill="rgba(92,201,245,.08)" stroke="#5cc9f5" stroke-width="1"/>
  <circle id="rightPupil" cx="185" cy="125" r="7" fill="url(#oceanGrad)" filter="url(#glow)"/>
  <circle cx="187" cy="123" r="2.5" fill="white" opacity=".7"/>
</g>
<rect id="leftEyelid" x="117" y="107" width="36" height="0" fill="#061222" opacity="0"/>
<rect id="rightEyelid" x="167" y="107" width="36" height="0" fill="#061222" opacity="0"/>
<!-- mouth -->
<path id="mouthSmile" d="M 140 155 Q 160 162 180 155" stroke="url(#oceanGrad)" stroke-width="2" fill="none" filter="url(#glow)"/>
<g id="mouthBars" opacity="0">
  <circle cx="145" cy="158" r="3" fill="#64ffda" filter="url(#glow)"><animate attributeName="r" values="2;5;2" dur=".4s" repeatCount="indefinite"/></circle>
  <circle cx="155" cy="157" r="4" fill="#5cc9f5" filter="url(#glow)"><animate attributeName="r" values="3;6;3" dur=".3s" repeatCount="indefinite"/></circle>
  <circle cx="165" cy="157" r="4" fill="#64ffda" filter="url(#glow)"><animate attributeName="r" values="4;7;4" dur=".5s" repeatCount="indefinite"/></circle>
  <circle cx="175" cy="158" r="3" fill="#5cc9f5" filter="url(#glow)"><animate attributeName="r" values="2;5;2" dur=".35s" repeatCount="indefinite"/></circle>
</g>
<g id="thinkingParticles" opacity="0"></g>
`;

// ASCII stays text-based (handled separately)
FACES['ascii'] = FACES['default']; // fallback SVG (hidden by CSS)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Eye position config per face (pupil centers & eyelid rects)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const EYE_CONFIG = {
    'default':    { lx:135, ly:150, rx:185, ry:150, elx:117, ely:132, erx:167, ery:132, ew:36, maxOff:5 },
    'matrix':     { lx:137, ly:148, rx:182, ry:148, elx:120, ely:135, erx:165, ery:135, ew:35, maxOff:3 },
    'god':        { lx:135, ly:150, rx:185, ry:150, elx:110, ely:138, erx:165, ery:138, ew:50, maxOff:5 },
    'futuristic': { lx:140, ly:148, rx:180, ry:148, elx:125, ely:138, erx:165, ery:138, ew:30, maxOff:4 },
    'ocean':      { lx:135, ly:125, rx:185, ry:125, elx:117, ely:107, erx:167, ery:107, ew:36, maxOff:5 },
    'ascii':      { lx:135, ly:150, rx:185, ry:150, elx:117, ely:132, erx:167, ery:132, ew:36, maxOff:5 },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ASCII FACES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ASCII_FACES = {
    idle: `
  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â•‘    â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”   â•‘
  â•‘    â”‚ â—‰ â”‚ â”‚ â—‰ â”‚   â•‘
  â•‘    â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜   â•‘
  â•‘                  â•‘
  â•‘     â•°â”€â”€â”€â”€â”€â”€â•¯     â•‘
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      â•±â•±  â–“â–“â–“  â•²â•²
     â•±â•±  â–“â–“â–“â–“â–“  â•²â•²`,
    thinking: `
  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â•‘    â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”   â•‘
  â•‘    â”‚ â”€ â”‚ â”‚ â”€ â”‚   â•‘
  â•‘    â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜   â•‘
  â•‘            . . . â•‘
  â•‘     â•°â”€â”€â”€â•¯        â•‘
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      â•±â•±  â–“â–“â–“  â•²â•²
     â•±â•±  â–“â–“â–“â–“â–“  â•²â•²`,
    speaking: `
  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â•‘    â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”   â•‘
  â•‘    â”‚ â—‰ â”‚ â”‚ â—‰ â”‚   â•‘
  â•‘    â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜   â•‘
  â•‘                  â•‘
  â•‘     â”ƒâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”ƒ     â•‘
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      â•±â•±  â–“â–“â–“  â•²â•²
     â•±â•±  â–“â–“â–“â–“â–“  â•²â•²`,
    blink: `
  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â•‘    â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”   â•‘
  â•‘    â”‚â”€â”€â”€â”‚ â”‚â”€â”€â”€â”‚   â•‘
  â•‘    â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜   â•‘
  â•‘                  â•‘
  â•‘     â•°â”€â”€â”€â”€â”€â”€â•¯     â•‘
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      â•±â•±  â–“â–“â–“  â•²â•²
     â•±â•±  â–“â–“â–“â–“â–“  â•²â•²`
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE & DOM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const state = {
    ws: null, token: null, sessionKey: null, currentState: 'idle',
    connected: false, streamingMessage: null, streamBuffer: '',
    currentTheme: localStorage.getItem('clawdbot-webchat-theme') || (CFG.defaultTheme || 'default')
};

const $ = id => document.getElementById(id);
const el = {
    statusText: $('statusText'), chatMessages: $('chatMessages'),
    chatInput: $('chatInput'), sendButton: $('sendButton'),
    avatarSvg: $('avatarSvg'), asciiFace: $('asciiFace'),
    bgParticles: $('bgParticles'), matrixRain: $('matrixRain'),
    avatarContainer: document.querySelector('.avatar-container'),
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INITIALIZE UI WITH CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initUI() {
    const botTitle = `${CFG.emoji || 'ğŸ¤–'} ${CFG.name || 'Clawdbot'}`;
    $('loginTitle').textContent = botTitle;
    $('loginSubtitle').textContent = L.tokenPrompt;
    $('tokenInput').placeholder = L.tokenPlaceholder;
    $('loginButton').textContent = L.connect;
    $('chatTitle').textContent = botTitle;
    $('newSessionTooltip').textContent = L.newSession;
    $('newSessionBtn').title = L.newSession;
    $('chatInput').placeholder = L.messagePlaceholder;
    $('attachButton').title = L.attachFile;
    $('sendButton').title = L.send;
    $('fileRemove').title = L.remove;
    $('confirmCancel').textContent = L.cancel;
    $('confirmOk').textContent = L.confirm;
    $('fileInput').accept = CFG.allowedFileTypes || 'image/*,video/*,audio/*,.gif,.pdf,.doc,.docx,.txt,.csv,.json,.xml,.zip';
    el.statusText.textContent = L.starting;
}

initUI();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THEME ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setTheme(theme) {
    if (theme === 'default') document.documentElement.removeAttribute('data-theme');
    else document.documentElement.setAttribute('data-theme', theme);
    state.currentTheme = theme;
    localStorage.setItem('clawdbot-webchat-theme', theme);
    document.querySelectorAll('.theme-btn').forEach(b => b.classList.toggle('active', b.dataset.theme === theme));

    // Swap face SVG
    el.avatarSvg.innerHTML = FACES[theme] || FACES['default'];
    // Re-grab dynamic elements
    refreshFaceElements();

    if (theme === 'matrix') initMatrixRain();
    if (theme === 'ascii') startAsciiAnimation();

    // Re-apply current state visuals
    const s = state.currentState;
    state.currentState = ''; // force re-apply
    setState(s || 'idle');
}

function refreshFaceElements() {
    el.leftPupil = $('leftPupil');
    el.rightPupil = $('rightPupil');
    el.leftEyelid = $('leftEyelid');
    el.rightEyelid = $('rightEyelid');
    el.mouthSmile = $('mouthSmile');
    el.mouthBars = $('mouthBars');
    el.workingRing = $('workingRing');
    el.ringRotate = $('ringRotate');
    el.thinkingParticles = $('thinkingParticles');
}

setTheme(state.currentTheme);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BG EFFECTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initBgParticles() {
    el.bgParticles.innerHTML = '';
    for (let i = 0; i < 20; i++) {
        const p = document.createElement('div');
        p.className = 'bg-particle';
        p.style.left = Math.random()*100+'%';
        p.style.setProperty('--dur',(6+Math.random()*10)+'s');
        p.style.setProperty('--delay',(Math.random()*8)+'s');
        const s = (2+Math.random()*3)+'px'; p.style.width=s; p.style.height=s;
        el.bgParticles.appendChild(p);
    }
}
initBgParticles();

function initMatrixRain() {
    el.matrixRain.innerHTML = '';
    const c = 'ã‚¢ã‚¤ã‚¦ã‚¨ã‚ªã‚«ã‚­ã‚¯ã‚±ã‚³ã‚µã‚·ã‚¹ã‚»ã‚½ã‚¿ãƒãƒ„ãƒ†ãƒˆ0123456789';
    for (let i=0;i<25;i++) {
        const col = document.createElement('div');
        col.className='matrix-column';
        col.style.left=(i*4+Math.random()*3)+'%';
        col.style.setProperty('--speed',(5+Math.random()*10)+'s');
        col.style.animationDelay=(Math.random()*5)+'s';
        col.style.opacity=.1+Math.random()*.3;
        let t=''; for(let j=0;j<20;j++) t+=c[Math.floor(Math.random()*c.length)]+'\n';
        col.textContent=t; el.matrixRain.appendChild(col);
    }
}

let asciiInt;
function startAsciiAnimation() {
    clearInterval(asciiInt);
    el.asciiFace.textContent = ASCII_FACES.idle;
    asciiInt = setInterval(()=>{
        if(state.currentTheme!=='ascii'){clearInterval(asciiInt);return;}
        if(state.currentState==='idle'&&Math.random()<.3){
            el.asciiFace.textContent=ASCII_FACES.blink;
            setTimeout(()=>{if(state.currentState==='idle')el.asciiFace.textContent=ASCII_FACES.idle;},200);
        }
    },3000);
}

function updateAsciiFace(s) {
    if(state.currentTheme!=='ascii') return;
    el.asciiFace.textContent = s==='thinking'||s==='working'?ASCII_FACES.thinking:s==='speaking'?ASCII_FACES.speaking:ASCII_FACES.idle;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOKEN & AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getTokenFromURL(){const m=window.location.search.match(/[?&]token=([^&]*)/);if(m)return m[1].replace(/%2B/gi,'+').replace(/%3D/gi,'=').replace(/%2F/gi,'/');return new URLSearchParams(window.location.search).get('token');}
function getToken(){return getTokenFromURL()||localStorage.getItem('clawdbot-webchat-token')||null;}
function saveToken(t){localStorage.setItem('clawdbot-webchat-token',t);}
function uuid(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0;return(c==='x'?r:(r&0x3|0x8)).toString(16)});}
function fmtTime(d){const locale = CFG.locale === 'tr' ? 'tr-TR' : 'en-US'; return d.toLocaleTimeString(locale,{hour:'2-digit',minute:'2-digit'});}

const loginOverlay=$('loginOverlay'),tokenInput=$('tokenInput'),loginButton=$('loginButton'),loginError=$('loginError');
function showLogin(){loginOverlay.classList.remove('hidden');}
function hideLogin(){loginOverlay.classList.add('hidden');}
function handleLogin(){const t=tokenInput.value.trim();if(!t){loginError.textContent=L.tokenEmpty;return;}loginError.textContent='';saveToken(t);state.token=t;hideLogin();connectWebSocket();}
loginButton.addEventListener('click',handleLogin);
tokenInput.addEventListener('keydown',e=>{if(e.key==='Enter')handleLogin();});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEBSOCKET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function connectWebSocket(){
    state.token=state.token||getToken();
    if(!state.token){showLogin();return;}
    hideLogin();
    const p=location.protocol==='https:'?'wss:':'ws:';
    el.statusText.textContent=L.connecting;
    state.ws=new WebSocket(`${p}//${location.host}`);
    state.ws.onopen=()=>state.ws.send(JSON.stringify({type:'req',id:uuid(),method:'connect',params:{minProtocol:3,maxProtocol:3,client:{id:'clawdbot-webchat-ui',version:'1.0.0',platform:'web',mode:'webchat'},auth:{token:state.token},caps:[]}}));
    state.ws.onmessage=e=>{try{handleMsg(JSON.parse(e.data))}catch(er){console.error(er);}};
    state.ws.onerror=()=>{el.statusText.textContent=L.connectionError;setState('idle');};
    state.ws.onclose=ev=>{
        state.connected=false;setState('idle');
        if(ev.code===4001||ev.code===4003||(ev.reason&&ev.reason.toLowerCase().includes('auth'))){
            localStorage.removeItem('clawdbot-webchat-token');state.token=null;
            el.statusText.textContent=L.sessionExpired;showLogin();loginError.textContent=L.tokenInvalid;
        }else{el.statusText.textContent=ev.reason?`${L.disconnectedRetrying}${ev.reason}`:L.disconnected;setTimeout(connectWebSocket,5000);}
    };
}

function getSessionKey(){
    return CFG.sessionKey || 'main';
}

function handleMsg(m){
    console.log('[clawdbot-webchat]',m.type,m.event||m.id||'',m.payload?.type||m.payload?.status||'');
    if(m.type==='res'&&!state.connected){
        if(m.error||m.ok===false){
            const e=m.error?.message||JSON.stringify(m.error);
            if(e&&(e.includes('auth')||e.includes('token')||e.includes('denied'))){
                localStorage.removeItem('clawdbot-webchat-token');state.token=null;showLogin();loginError.textContent=L.tokenInvalid;state.ws.close();
            }else el.statusText.textContent=L.error+e;
            setState('idle');
        }else{state.connected=true;state.sessionKey=getSessionKey();saveToken(state.token);el.statusText.textContent=L.ready;setState('idle');loadHistory();}
    }else if(m.type==='res'&&state.connected&&state.historyReqId&&m.id===state.historyReqId){handleHistoryResponse(m);}
    else if(m.type==='res'&&state.connected&&m.payload?.messages){handleHistoryResponse(m);}
    else if(m.type==='event'&&m.event==='agent'){handleAgent(m);}
    else if(m.type==='event'&&m.event==='chat'){handleChat(m);}
    else if(m.type==='res'&&state.connected&&(m.payload?.runId||m.payload?.status==='started'))setState('thinking');
    else if(m.type==='res'&&state.connected&&m.payload?.status==='ok'&&m.payload?.summary){addMessage('assistant',m.payload.summary);setState('idle');}
}

function loadHistory(){
    state.historyReqId=uuid();
    state.ws.send(JSON.stringify({type:'req',id:state.historyReqId,method:'chat.history',params:{sessionKey:state.sessionKey,limit:100}}));
}

function handleHistoryResponse(m){
    state.historyReqId=null;
    console.log('[clawdbot-webchat] history payload keys:', Object.keys(m.payload||{}));
    const msgs=m.payload?.messages||m.result?.messages||[];
    console.log('[clawdbot-webchat] history messages count:', msgs.length);
    if(msgs.length===0){addMessage('assistant',L.welcomeMessage);return;}
    el.chatMessages.innerHTML='';
    state.lastDateLabel='';
    for(const msg of msgs){
        const role=msg.role||'unknown';
        if(role==='system'||role==='tool')continue;
        const ts=msg.timestamp?(typeof msg.timestamp==='number'?new Date(msg.timestamp):new Date(msg.timestamp)):null;
        let text='';
        if(typeof msg.content==='string')text=msg.content;
        else if(Array.isArray(msg.content))text=msg.content.filter(c=>c.type==='text').map(c=>c.text||'').join('\n');
        if(!text.trim())continue;
        const sender=role==='user'?'user':'assistant';
        addMessage(sender,text,false,ts);
    }
    el.chatMessages.scrollTop=el.chatMessages.scrollHeight;
}

function formatDateSeparator(d){
    const now=new Date();
    const today=new Date(now.getFullYear(),now.getMonth(),now.getDate());
    const msgDay=new Date(d.getFullYear(),d.getMonth(),d.getDate());
    const diff=Math.floor((today-msgDay)/(1000*60*60*24));
    if(diff===0)return L.today;
    if(diff===1)return L.yesterday;
    const locale = CFG.locale === 'tr' ? 'tr-TR' : 'en-US';
    return d.toLocaleDateString(locale,{day:'numeric',month:'long',year:'numeric'});
}

function addDateSeparator(label){
    const sep=document.createElement('div');
    sep.className='date-separator';
    sep.innerHTML=`<span>${label}</span>`;
    el.chatMessages.appendChild(sep);
}

function showTypingIndicator(){
    if(document.getElementById('typingIndicator'))return;
    const m=document.createElement('div');m.className='typing-indicator';m.id='typingIndicator';
    const c=document.createElement('div');c.className='message-content';
    const b=document.createElement('div');b.className='typing-bubble';
    b.innerHTML='<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
    c.appendChild(b);m.appendChild(c);
    el.chatMessages.appendChild(m);el.chatMessages.scrollTop=el.chatMessages.scrollHeight;
}
function hideTypingIndicator(){
    const t=document.getElementById('typingIndicator');if(t)t.remove();
}

function handleAgent(m){
    const p=m.payload||m.data||{};
    if(p.type==='text-delta'||p.delta||p.type==='delta'){
        hideTypingIndicator();
        setState('speaking');const c=p.delta||p.text||'';
        if(!state.streamingMessage){state.streamingMessage=addMessage('assistant','',true);state.streamBuffer='';}
        state.streamBuffer=(state.streamBuffer||'')+c;
        if(state.streamingMessage){state.streamingMessage.innerHTML=formatText(state.streamBuffer);el.chatMessages.scrollTop=el.chatMessages.scrollHeight;}
    }
    if(p.type==='tool_use'||p.type==='tool-start'){setState('working');showTypingIndicator();}
    if(p.type==='message'||p.state==='final'){
        hideTypingIndicator();setState('speaking');
        if(p.message?.content){const t=p.message.content.map(c=>c.text||'').join('');if(t){if(state.streamingMessage)state.streamingMessage.innerHTML=formatText(t);else addMessage('assistant',t);}}
        state.streamingMessage=null;state.streamBuffer='';setTimeout(()=>setState('idle'),1000);
    }
}

function handleChat(m){
    const p=m.payload||m.data||{};
    if(p.state==='final'&&p.message?.content){
        hideTypingIndicator();
        const t=p.message.content.map(c=>c.text||'').join('');
        if(t){if(state.streamingMessage)state.streamingMessage.innerHTML=formatText(t);else addMessage('assistant',t);}
        state.streamingMessage=null;state.streamBuffer='';setState('idle');
    }else if(p.state==='accepted'){setState('thinking');showTypingIndicator();}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MESSAGING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sendMessage(){
    const t=el.chatInput.value.trim();
    const hasFile=!!state.pendingFile;
    if((!t&&!hasFile)||!state.connected)return;

    if(hasFile){
        const file=state.pendingFile;
        // Show media preview in user message
        const thumbUrl=URL.createObjectURL(file);
        if(file.type.startsWith('image/')||file.name.toLowerCase().endsWith('.gif')){
            addMessage('user',t||'',false,null,{type:'image',url:thumbUrl,name:file.name});
        }else if(file.type.startsWith('video/')){
            addMessage('user',t||'',false,null,{type:'video',url:thumbUrl,name:file.name,mimeType:file.type});
        }else if(file.type.startsWith('audio/')){
            addMessage('user',t||'',false,null,{type:'audio',url:thumbUrl,name:file.name,mimeType:file.type});
        }else{
            const displayText=t?`ğŸ“ ${file.name}\n${t}`:`ğŸ“ ${file.name}`;
            addMessage('user',displayText);
        }
        clearFile();
        el.chatInput.value='';autoResize();setState('thinking');showTypingIndicator();
        try{
            const fd=await uploadFile(file);
            const msg=t||`${L.analyzeFile}${file.name}`;
            const attachments=[{
                type:file.type.startsWith('image/')?'image':'file',
                mimeType:file.type||'application/octet-stream',
                fileName:file.name,
                content:fd.data
            }];
            state.ws.send(JSON.stringify({type:'req',id:uuid(),method:'chat.send',params:{
                sessionKey:state.sessionKey,
                message:msg,
                attachments:attachments,
                deliver:false,
                idempotencyKey:uuid()
            }}));
        }catch(err){
            hideTypingIndicator();setState('idle');
            addMessage('assistant','âŒ '+L.fileUploadError+err.message);
        }
    }else{
        addMessage('user',t);
        state.ws.send(JSON.stringify({type:'req',id:uuid(),method:'chat.send',params:{sessionKey:state.sessionKey,message:t,deliver:false,idempotencyKey:uuid()}}));
        el.chatInput.value='';autoResize();setState('thinking');showTypingIndicator();
    }
}

function formatText(text){
    // Basic: paragraphs, bold, italic, code, links
    let html=text
        .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
        .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
        .replace(/\*(.+?)\*/g,'<em>$1</em>')
        .replace(/`([^`]+)`/g,'<code style="background:rgba(255,255,255,.1);padding:1px 4px;border-radius:3px;font-family:var(--font-mono);font-size:.85em">$1</code>')
        .replace(/(https?:\/\/[^\s<]+)/g,'<a href="$1" target="_blank" rel="noopener" style="color:var(--accent-2);text-decoration:underline">$1</a>');
    // Paragraphs: double newline
    html=html.split(/\n\n+/).map(p=>`<p style="margin:0 0 .5em 0">${p.replace(/\n/g,'<br>')}</p>`).join('');
    return html;
}

function addMessage(sender,text,streaming=false,timestamp=null,attachment=null){
    const ts=timestamp||new Date();
    // Date separator check
    const dateStr=formatDateSeparator(ts instanceof Date?ts:new Date(ts));
    if(dateStr!==state.lastDateLabel){addDateSeparator(dateStr);state.lastDateLabel=dateStr;}

    const m=document.createElement('div');m.className=`message ${sender}`;
    const c=document.createElement('div');c.className='message-content';
    const b=document.createElement('div');b.className='message-bubble';
    
    // Media attachment previews
    if(attachment&&attachment.type==='image'){
        const imgWrap=document.createElement('div');
        imgWrap.style.cssText='margin-bottom:4px;border-radius:8px;overflow:hidden;max-width:240px;';
        const img=document.createElement('img');
        img.src=attachment.url;
        img.alt=attachment.name||'image';
        img.style.cssText='width:100%;display:block;border-radius:8px;cursor:pointer;';
        img.onclick=()=>{window.open(attachment.url,'_blank');};
        imgWrap.appendChild(img);
        b.appendChild(imgWrap);
        if(text){const txt=document.createElement('div');txt.innerHTML=formatText(text);b.appendChild(txt);}
    }else if(attachment&&attachment.type==='video'){
        const vidWrap=document.createElement('div');
        vidWrap.style.cssText='margin-bottom:4px;border-radius:8px;overflow:hidden;max-width:280px;';
        const vid=document.createElement('video');
        vid.src=attachment.url;
        vid.controls=true;vid.preload='metadata';vid.playsInline=true;
        vid.style.cssText='width:100%;display:block;border-radius:8px;max-height:200px;';
        vidWrap.appendChild(vid);
        b.appendChild(vidWrap);
        if(text){const txt=document.createElement('div');txt.innerHTML=formatText(text);b.appendChild(txt);}
    }else if(attachment&&attachment.type==='audio'){
        const audioWrap=document.createElement('div');
        audioWrap.style.cssText='margin-bottom:6px;display:flex;align-items:center;gap:8px;';
        const audioIcon=document.createElement('span');audioIcon.textContent='ğŸµ';audioIcon.style.fontSize='1.3rem';
        const audioName=document.createElement('span');
        audioName.textContent=attachment.name||'audio';
        audioName.style.cssText='font-size:.8rem;color:var(--text-secondary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:180px;';
        audioWrap.appendChild(audioIcon);audioWrap.appendChild(audioName);
        b.appendChild(audioWrap);
        const aud=document.createElement('audio');
        aud.src=attachment.url;aud.controls=true;aud.preload='metadata';
        aud.style.cssText='width:100%;max-width:260px;height:36px;margin-bottom:4px;';
        b.appendChild(aud);
        if(text){const txt=document.createElement('div');txt.innerHTML=formatText(text);b.appendChild(txt);}
    }else if(streaming){
        b.textContent='';
    }else{
        b.innerHTML=formatText(text);
    }
    
    const t=document.createElement('div');t.className='message-time';
    t.textContent=fmtTime(ts instanceof Date?ts:new Date(ts));
    c.appendChild(b);c.appendChild(t);m.appendChild(c);
    el.chatMessages.appendChild(m);el.chatMessages.scrollTop=el.chatMessages.scrollHeight;
    return streaming?b:null;
}

// Track last date label for separator logic
state.lastDateLabel='';
state.pendingFile=null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILE UPLOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const fileInput=$('fileInput'),attachButton=$('attachButton'),filePreview=$('filePreview');
const fileName=$('fileName'),fileSize=$('fileSize'),fileThumb=$('fileThumb'),fileRemove=$('fileRemove');

attachButton.addEventListener('click',()=>fileInput.click());
fileRemove.addEventListener('click',clearFile);

fileInput.addEventListener('change',e=>{
    const f=e.target.files[0];if(!f)return;
    state.pendingFile=f;
    fileName.textContent=f.name;
    fileSize.textContent=formatFileSize(f.size);
    fileThumb.innerHTML='';
    if(f.type.startsWith('image/')||f.name.toLowerCase().endsWith('.gif')){
        const img=document.createElement('img');img.className='file-preview-thumb';
        const objUrl=URL.createObjectURL(f);
        img.src=objUrl;
        img.onload=()=>URL.revokeObjectURL(objUrl);
        fileThumb.appendChild(img);
    }else if(f.type.startsWith('video/')){
        const vid=document.createElement('video');vid.className='file-preview-thumb';
        vid.style.objectFit='cover';
        const objUrl=URL.createObjectURL(f);
        vid.src=objUrl;vid.muted=true;vid.preload='metadata';
        vid.onloadeddata=()=>{vid.currentTime=0.5;};
        fileThumb.appendChild(vid);
    }else if(f.type.startsWith('audio/')){
        const icon=document.createElement('div');icon.className='file-preview-icon';
        icon.textContent='ğŸµ';fileThumb.appendChild(icon);
    }else{
        const icon=document.createElement('div');icon.className='file-preview-icon';
        icon.textContent=getFileIcon(f.name);fileThumb.appendChild(icon);
    }
    filePreview.classList.add('active');
    el.chatInput.focus();
    fileInput.value='';
});

function clearFile(){state.pendingFile=null;filePreview.classList.remove('active');fileThumb.innerHTML='';fileInput.value='';}
function formatFileSize(b){if(b<1024)return b+' B';if(b<1048576)return(b/1024).toFixed(1)+' KB';return(b/1048576).toFixed(1)+' MB';}
function getFileIcon(name){const ext=name.split('.').pop().toLowerCase();return{pdf:'ğŸ“„',doc:'ğŸ“',docx:'ğŸ“',txt:'ğŸ“„',csv:'ğŸ“Š',json:'ğŸ”§',xml:'ğŸ”§',zip:'ğŸ“¦',mp4:'ğŸ¬',mov:'ğŸ¬',avi:'ğŸ¬',webm:'ğŸ¬',mp3:'ğŸµ',wav:'ğŸµ',ogg:'ğŸµ',flac:'ğŸµ',gif:'ğŸï¸',png:'ğŸ–¼ï¸',jpg:'ğŸ–¼ï¸',jpeg:'ğŸ–¼ï¸',webp:'ğŸ–¼ï¸'}[ext]||'ğŸ“';}

const MAX_FILE_SIZE = CFG.maxFileSize || (5*1024*1024); // 5MB gateway limit

async function uploadFile(file){
    if(file.size>MAX_FILE_SIZE){
        const sizeStr = formatFileSize(file.size);
        const maxStr = formatFileSize(MAX_FILE_SIZE);
        throw new Error(L.fileTooLarge.replace('{size}', sizeStr).replace('{max}', maxStr));
    }
    const reader=new FileReader();
    return new Promise((resolve,reject)=>{
        reader.onload=()=>{
            const base64=reader.result.split(',')[1];
            resolve({name:file.name,type:file.type,size:file.size,data:base64});
        };
        reader.onerror=()=>reject(new Error(L.fileReadError));
        reader.readAsDataURL(file);
    });
}

// Drag & drop support
const chatSection=document.querySelector('.chat-section');
chatSection.addEventListener('dragover',e=>{e.preventDefault();e.stopPropagation();chatSection.style.outline='2px dashed var(--accent-1)';});
chatSection.addEventListener('dragleave',e=>{e.preventDefault();chatSection.style.outline='none';});
chatSection.addEventListener('drop',e=>{
    e.preventDefault();chatSection.style.outline='none';
    const f=e.dataTransfer?.files?.[0];
    if(f){fileInput.files=e.dataTransfer.files;fileInput.dispatchEvent(new Event('change'));}
});

function autoResize(){const i=el.chatInput;i.style.height='auto';i.style.height=Math.min(i.scrollHeight,120)+'px';}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AVATAR STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setState(s){
    if(state.currentState===s)return;
    state.currentState=s;
    if(el.mouthSmile)el.mouthSmile.setAttribute('opacity','0');
    if(el.mouthBars)el.mouthBars.setAttribute('opacity','0');
    if(el.workingRing)el.workingRing.setAttribute('opacity','0');
    if(el.ringRotate)el.ringRotate.setAttribute('repeatCount','0');
    if(el.thinkingParticles)el.thinkingParticles.setAttribute('opacity','0');

    switch(s){
        case 'idle':
            el.statusText.textContent=state.connected?L.ready:L.connecting;
            if(el.mouthSmile)el.mouthSmile.setAttribute('opacity','1');
            openEyes();break;
        case 'listening':
            el.statusText.textContent=L.listening;
            if(el.mouthSmile)el.mouthSmile.setAttribute('opacity','1');
            halfCloseEyes();break;
        case 'thinking':
            el.statusText.textContent=L.thinking;
            if(el.mouthSmile)el.mouthSmile.setAttribute('opacity','1');
            startThinking();break;
        case 'working':
            el.statusText.textContent=L.working;
            if(el.mouthSmile)el.mouthSmile.setAttribute('opacity','1');
            if(el.workingRing){el.workingRing.setAttribute('opacity','1');el.ringRotate.setAttribute('repeatCount','indefinite');el.ringRotate.beginElement();}
            break;
        case 'speaking':
            el.statusText.textContent=L.speaking;
            if(el.mouthBars)el.mouthBars.setAttribute('opacity','1');
            openEyes();break;
    }
    updateAsciiFace(s);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EYE CONTROL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function trackMouse(e){
    if(state.currentState!=='idle'||!el.leftPupil)return;
    const cfg=EYE_CONFIG[state.currentTheme]||EYE_CONFIG['default'];
    const r=el.avatarContainer.getBoundingClientRect();
    const cx=r.left+r.width/2, cy=r.top+r.height/2;
    const dx=Math.max(-cfg.maxOff,Math.min(cfg.maxOff,(e.clientX-cx)/15));
    const dy=Math.max(-cfg.maxOff,Math.min(cfg.maxOff,(e.clientY-cy)/15));
    el.leftPupil.setAttribute('cx',cfg.lx+dx);el.leftPupil.setAttribute('cy',cfg.ly+dy);
    el.rightPupil.setAttribute('cx',cfg.rx+dx);el.rightPupil.setAttribute('cy',cfg.ry+dy);
}

function blink(){
    if(!el.leftEyelid)return;
    const cfg=EYE_CONFIG[state.currentTheme]||EYE_CONFIG['default'];
    const dur=150,maxH=cfg.ew?Math.min(36,cfg.ew):36;
    el.leftEyelid.setAttribute('opacity','1');el.rightEyelid.setAttribute('opacity','1');
    let start=null;
    function anim(ts){
        if(!start)start=ts;const p=Math.min(1,(ts-start)/dur);
        const h=Math.max(0,p<.5?maxH*(p*2):maxH*(2-p*2));
        el.leftEyelid.setAttribute('height',h);el.rightEyelid.setAttribute('height',h);
        if(p<1)requestAnimationFrame(anim);
        else{el.leftEyelid.setAttribute('height','0');el.leftEyelid.setAttribute('opacity','0');el.rightEyelid.setAttribute('height','0');el.rightEyelid.setAttribute('opacity','0');}
    }
    requestAnimationFrame(anim);
}

function halfCloseEyes(){
    if(!el.leftEyelid)return;
    el.leftEyelid.setAttribute('opacity','1');el.rightEyelid.setAttribute('opacity','1');
    el.leftEyelid.setAttribute('height','18');el.rightEyelid.setAttribute('height','18');
}

function openEyes(){
    if(!el.leftEyelid)return;
    el.leftEyelid.setAttribute('opacity','0');el.rightEyelid.setAttribute('opacity','0');
    el.leftEyelid.setAttribute('height','0');el.rightEyelid.setAttribute('height','0');
}

function startThinking(){
    if(!el.thinkingParticles)return;
    el.thinkingParticles.setAttribute('opacity','1');el.thinkingParticles.innerHTML='';
    const cfg=EYE_CONFIG[state.currentTheme]||EYE_CONFIG['default'];
    const midX=(cfg.lx+cfg.rx)/2, midY=(cfg.ly+cfg.ry)/2;
    for(let i=0;i<12;i++){
        const a=(i/12)*Math.PI*2, r=105;
        const p=document.createElementNS('http://www.w3.org/2000/svg','circle');
        p.setAttribute('cx',midX+Math.cos(a)*r);p.setAttribute('cy',midY+Math.sin(a)*r);
        p.setAttribute('r','3');p.setAttribute('fill','var(--accent-1)');p.setAttribute('opacity','0');
        const an=document.createElementNS('http://www.w3.org/2000/svg','animate');
        an.setAttribute('attributeName','opacity');an.setAttribute('values','0;1;0');an.setAttribute('dur','2s');an.setAttribute('begin',`${i*.17}s`);an.setAttribute('repeatCount','indefinite');
        p.appendChild(an);el.thinkingParticles.appendChild(p);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EVENT LISTENERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('mousemove',trackMouse);
document.addEventListener('touchmove',e=>{if(e.touches.length)trackMouse({clientX:e.touches[0].clientX,clientY:e.touches[0].clientY});});
el.chatInput.addEventListener('input',()=>{autoResize();if(el.chatInput.value.length>0&&state.currentState==='idle')setState('listening');else if(!el.chatInput.value.length&&state.currentState==='listening')setState('idle');});
el.chatInput.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();}});
el.sendButton.addEventListener('click',sendMessage);
el.chatInput.addEventListener('focus',()=>{if(/iPhone|iPad|iPod/.test(navigator.userAgent))document.querySelector('meta[name=viewport]').setAttribute('content','width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');});
setInterval(()=>{if(Math.random()<.3&&state.currentState==='idle')blink();},3000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NEW SESSION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function customConfirm(msg){
    return new Promise(resolve=>{
        const overlay=$('confirmOverlay'),text=$('confirmText'),ok=$('confirmOk'),cancel=$('confirmCancel');
        text.textContent=msg;overlay.classList.add('active');
        function cleanup(result){overlay.classList.remove('active');ok.removeEventListener('click',onOk);cancel.removeEventListener('click',onCancel);overlay.removeEventListener('click',onBg);resolve(result);}
        function onOk(){cleanup(true);}
        function onCancel(){cleanup(false);}
        function onBg(e){if(e.target===overlay)cleanup(false);}
        ok.addEventListener('click',onOk);cancel.addEventListener('click',onCancel);overlay.addEventListener('click',onBg);
    });
}

$('newSessionBtn').addEventListener('click',async()=>{
    if(!state.connected)return;
    if(!await customConfirm(L.newSessionConfirm))return;
    state.ws.send(JSON.stringify({type:'req',id:uuid(),method:'chat.send',params:{sessionKey:state.sessionKey,message:'/new',deliver:false,idempotencyKey:uuid()}}));
    el.chatMessages.innerHTML='';
    state.lastDateLabel='';
    state.streamingMessage=null;state.streamBuffer='';
    hideTypingIndicator();
    setState('idle');
    setTimeout(()=>addMessage('assistant',L.newSessionStarted),500);
});

// GO
connectWebSocket();
</script>
</body>
</html>
